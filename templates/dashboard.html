<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>FormBot ‚Äî Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dashboard-page">

  <div class="grid-bg"></div>
  <div class="scan-line"></div>

  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <div class="brand-icon small">
        <svg viewBox="0 0 48 48" fill="none">
          <rect x="6" y="6" width="36" height="36" rx="6" stroke="var(--accent)" stroke-width="2"/>
          <path d="M14 18h20M14 24h14M14 30h8" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round"/>
          <circle cx="36" cy="30" r="5" fill="var(--accent)" opacity="0.9"/>
          <path d="M34 30l1.5 1.5L38 28" stroke="#0a0a0f" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <span>FORMBOT</span>
    </div>

    <nav class="sidebar-nav">
      <a href="#config-section" class="nav-item active">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M4.93 4.93l1.41 1.41M4.93 19.07l1.41-1.41M19.07 19.07l-1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/></svg>
        <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </a>
      <a href="#log-section" class="nav-item">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        <span>Log</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-chip">
        <div class="user-avatar">{{ user[0].upper() }}</div>
        <div class="user-info">
          <span class="user-name">{{ user }}</span>
          <span class="user-role">Operator</span>
        </div>
      </div>
      <a href="{{ url_for('logout') }}" class="btn-logout" title="Logout">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
      </a>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <main class="main-content">

    <!-- Top Bar -->
    <header class="topbar">
      <div class="topbar-left">
        <h2 class="page-title">Bot Control Panel</h2>
        <span class="page-subtitle">Google Form Automation</span>
      </div>
      <div class="topbar-right">
        <div class="status-indicator" id="globalStatus">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">IDLE</span>
        </div>
        <div class="progress-mini" id="progressWrap" style="display:none">
          <div class="progress-bar-mini" id="progressBarMini"></div>
          <span id="progressLabel">0/0</span>
        </div>
      </div>
    </header>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container inline">
          {% for category, message in messages %}
            <div class="flash flash-{{ category }}">
              <span class="flash-icon">{% if category == 'success' %}‚úì{% elif category == 'error' %}‚úó{% else %}‚Ñπ{% endif %}</span>
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- ===== CONFIG FORM ===== -->
    <section class="card config-card" id="config-section">
      <div class="card-header">
        <div class="header-dot"></div>
        <div class="header-dot dot-yellow"></div>
        <div class="header-dot dot-green"></div>
        <span class="card-title">// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏ö‡∏≠‡∏ó</span>
      </div>

      <div class="config-grid">

        <!-- URL -->
        <div class="form-group full-width">
          <label><span class="label-prefix">$</span> GOOGLE FORM URL</label>
          <div class="input-wrapper">
            <span class="input-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            </span>
            <input type="url" id="url" placeholder="https://docs.google.com/forms/..." />
          </div>
        </div>

        <!-- Mode + Speed -->
        <div class="form-group">
          <label><span class="label-prefix">$</span> ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
          <div class="select-wrapper">
            <select id="mode">
              <option value="random">üé≤ Auto-Random (‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤)</option>
              <option value="exact">ü§ñ Copy Exact (‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤)</option>
              <option value="mix">üçπ Mix Mode (‡∏ó‡∏≥‡πÄ‡∏≠‡∏á‡∏ö‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ + ‡∏™‡∏∏‡πà‡∏°)</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label><span class="label-prefix">$</span> ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</label>
          <div class="radio-group">
            <label class="radio-card">
              <input type="radio" name="speed" value="fast" checked>
              <span class="radio-btn">
                <span class="radio-icon">üöÄ</span>
                <span class="radio-label">Fast Mode</span>
                <span class="radio-desc">‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏õ‡∏µ‡∏î</span>
              </span>
            </label>
            <label class="radio-card">
              <input type="radio" name="speed" value="human">
              <span class="radio-btn">
                <span class="radio-icon">üë§</span>
                <span class="radio-label">Human Mode</span>
                <span class="radio-desc">‡∏ä‡πâ‡∏≤ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span>
              </span>
            </label>
          </div>
        </div>

        <!-- Rounds + Dist -->
        <div class="form-group">
          <label><span class="label-prefix">$</span> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö</label>
          <div class="input-wrapper">
            <span class="input-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
            </span>
            <input type="number" id="rounds" value="1" min="1" max="999" />
          </div>
        </div>

        <div class="form-group">
          <label><span class="label-prefix">$</span> Distribution Mode</label>
          <div class="select-wrapper">
            <select id="dist_mode">
              <option value="1">üé≤ Equal (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)</option>
              <option value="2">üìä Skewed (‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏ö‡∏ô)</option>
              <option value="3">üìà Heavy (‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏ö‡∏ô‡∏°‡∏≤‡∏Å)</option>
            </select>
          </div>
        </div>

        <!-- Manual Pages -->
        <div class="form-group" id="manual_pages_group" style="display:none">
          <label><span class="label-prefix">$</span> ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏≠‡∏á (Mix Mode)</label>
          <div class="input-wrapper">
            <input type="text" id="manual_pages" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1+3+7" />
          </div>
        </div>

        <!-- Text Pool (‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô) -->
        <div class="form-group full-width">
          <label><span class="label-prefix">$</span> ‚úçÔ∏è ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (Text Pool)</label>
          <div class="input-wrapper">
            <input type="text" id="text_pool_raw" placeholder="‡πÉ‡∏ä‡πâ + ‡∏Ñ‡∏±‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏µ‡∏°‡∏≤‡∏Å+‡πÇ‡∏≠‡πÄ‡∏Ñ+‡∏û‡∏≠‡πÉ‡∏à+‡∏î‡∏µ (‡∏ö‡∏≠‡∏ó‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏™‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)" />
          </div>
          <p class="field-hint">‚ö†Ô∏è ‡∏ñ‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ö‡∏≠‡∏ó‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ</p>
        </div>

        <!-- Forbidden Words -->
        <div class="form-group">
          <label><span class="label-prefix">$</span> üö´ ‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°</label>
          <div class="input-wrapper">
            <input type="text" id="forbidden_words" placeholder="‡πÉ‡∏ä‡πâ + ‡∏Ñ‡∏±‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏î‡πâ‡∏ß‡∏¢+‡πÅ‡∏¢‡πà‡∏°‡∏≤‡∏Å" />
          </div>
        </div>

        <!-- Weight Map -->
        <div class="form-group">
          <label><span class="label-prefix">$</span> ‚öñÔ∏è Weight Map</label>
          <div class="input-wrapper">
            <textarea id="weight_map_raw" rows="3" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (1 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)&#10;5: 0:0:10:30:60&#10;4: 5:20:40:35"></textarea>
          </div>
          <p class="field-hint">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å1:‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å2:...</p>
        </div>

        <!-- Headless -->
        <div class="form-group">
          <label><span class="label-prefix">$</span> ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</label>
          <div class="toggle-group">
            <label class="toggle-switch">
              <input type="checkbox" id="headless" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Headless (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)</span>
          </div>
        </div>

        <!-- Auto Start -->
        <div class="form-group">
          <label><span class="label-prefix">$</span> ‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å</label>
          <div class="toggle-group">
            <label class="toggle-switch">
              <input type="checkbox" id="auto_start" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">‡∏ö‡∏≠‡∏ó Auto (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏≠‡∏á)</span>
          </div>
        </div>

      </div>

      <!-- Action Buttons -->
      <div class="action-bar">
        <button class="btn-run" id="btnStart" onclick="startBot()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          <span>START BOT</span>
        </button>
        <button class="btn-stop" id="btnStop" onclick="stopBot()" style="display:none">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
          <span>STOP</span>
        </button>
        <button class="btn-clear" onclick="clearLogs()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
          ‡∏•‡πâ‡∏≤‡∏á Log
        </button>
      </div>
    </section>

    <!-- ===== LOG TERMINAL ===== -->
    <section class="card log-card" id="log-section">
      <div class="card-header">
        <div class="header-dot"></div>
        <div class="header-dot dot-yellow"></div>
        <div class="header-dot dot-green"></div>
        <span class="card-title">// Console Output</span>
        <span class="log-live" id="liveBadge" style="display:none">‚óè LIVE</span>
      </div>

      <div class="log-terminal" id="logTerminal">
        <div class="log-placeholder">
          <span class="placeholder-icon">‚å¨</span>
          <span>‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á... ‡∏Å‡∏î START BOT ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="progress-section" id="progressSection" style="display:none">
        <div class="progress-label-row">
          <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
          <span id="progressText">0 / 0</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Console Input Bar (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏ó‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö) -->
      <div id="consoleInputBar" class="console-input-bar" style="display:none">
        <div class="console-input-question" id="consoleQuestion"></div>
        <div class="console-input-row">
          <span class="console-prompt">‚ùØ</span>
          <input
            type="text"
            id="consoleInput"
            class="console-input-field"
            placeholder=""
            autocomplete="off"
          />
          <button class="console-send-btn" id="consoleSendBtn" onclick="handleConsoleEnter()">‡∏™‡πà‡∏á ‚Üµ</button>
        </div>
        <div class="console-hint" id="consoleHint"></div>
      </div>
    </section>

  </main>

  <!-- ===== SCRIPTS ===== -->
  <script>
    let logOffset = 0;
    let pollInterval = null;
    // Queue of pending text-input questions waiting for user answer
    let pendingQueue = [];
    let currentPending = null;

    // Show/hide manual pages field
    document.getElementById('mode').addEventListener('change', function() {
      document.getElementById('manual_pages_group').style.display =
        this.value === 'mix' ? 'block' : 'none';
    });

    // Enter key in console input = send
    document.getElementById('consoleInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') handleConsoleEnter();
    });

    // =====================
    // Config
    // =====================
    function getConfig() {
      return {
        url: document.getElementById('url').value.trim(),
        mode: document.getElementById('mode').value,
        speed_mode: document.querySelector('input[name="speed"]:checked').value,
        rounds: parseInt(document.getElementById('rounds').value) || 1,
        dist_mode: parseInt(document.getElementById('dist_mode').value),
        forbidden_words: document.getElementById('forbidden_words').value,
        weight_map_raw: document.getElementById('weight_map_raw').value,
        manual_pages: document.getElementById('manual_pages').value,
        headless: document.getElementById('headless').checked,
        auto_start_first_round: document.getElementById('auto_start').checked,
      };
    }

    // =====================
    // Log
    // =====================
    function appendLog(msg, cls) {
      const terminal = document.getElementById('logTerminal');
      const placeholder = terminal.querySelector('.log-placeholder');
      if (placeholder) placeholder.remove();

      const line = document.createElement('div');
      line.className = 'log-line';

      if (!cls) {
        if (msg.includes('‚úÖ') || msg.includes('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢') || msg.includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')) cls = 'log-success';
        else if (msg.includes('‚ùå') || msg.includes('Error') || msg.includes('‚ö†Ô∏è')) cls = 'log-error';
        else if (msg.includes('>>>') || msg.includes('üéì') || msg.includes('üöÄ')) cls = 'log-highlight';
        else if (msg.includes('‚òï') || msg.includes('‚è≥') || msg.includes('‚ñ∂Ô∏è')) cls = 'log-info';
        else if (msg.includes('üö´')) cls = 'log-warn';
        else if (msg.includes('‚úçÔ∏è') || msg.includes('‚è∏Ô∏è') || msg.includes('üëâ')) cls = 'log-ask';
      }

      line.classList.add(cls || 'log-default');
      line.textContent = msg;
      terminal.appendChild(line);
      terminal.scrollTop = terminal.scrollHeight;
    }

    // =====================
    // Poll
    // =====================
    function pollLogs() {
      fetch(`/api/bot/logs?offset=${logOffset}`)
        .then(r => r.json())
        .then(data => {
          data.logs.forEach(l => appendLog(l));
          logOffset = data.total;

          const running  = data.running;
          const paused   = data.paused;
          const pending  = data.pending_inputs || [];
          const completed = data.completed;
          const total    = data.total_rounds;

          // Status
          const dot = document.getElementById('statusDot');
          const statusText = document.getElementById('statusText');
          dot.className = 'status-dot ' + (paused ? 'paused' : running ? 'active' : '');
          statusText.textContent = paused ? 'WAITING INPUT'
            : running ? 'RUNNING'
            : (completed >= total && total > 0 ? 'DONE' : 'IDLE');

          // Progress
          if (total > 0) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('progressWrap').style.display = 'flex';
            const pct = Math.round((completed / total) * 100);
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressText').textContent = `${completed} / ${total} ‡∏£‡∏≠‡∏ö`;
            document.getElementById('progressLabel').textContent = `${completed}/${total}`;
            document.getElementById('progressBarMini').style.width = pct + '%';
          }

          // Buttons
          document.getElementById('btnStart').style.display = running ? 'none' : 'flex';
          document.getElementById('btnStop').style.display = running ? 'flex' : 'none';
          document.getElementById('liveBadge').style.display = running ? 'inline-flex' : 'none';

          // Handle paused + pending questions
          if (paused && pending.length > 0) {
            // Load into queue if not already loaded
            if (pendingQueue.length === 0 && currentPending === null) {
              pendingQueue = [...pending];
              showNextQuestion();
            }
          }

          if (!paused && currentPending !== null) {
            // Bot resumed ‚Äî hide input bar
            hideConsoleInput();
          }

          if (!running && pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
          }
        })
        .catch(() => {});
    }

    // =====================
    // Console Input Logic
    // step: 'want_answer' | 'type_answer' | 'ask_linked'
    // =====================
    let _consoleStep = null;   // current step
    let _answers = {};         // collected answers

    // _consoleStep:
    //   'want_answer'  ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÑ‡∏´‡∏°? y/n
    //   'ask_linked'   ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 2+: ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏°? y/n  (‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)
    //   'type_answer'  ‚Üí ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    let _isLinkedDecision = false;  // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏• ask_linked ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

    function showNextQuestion() {
      if (pendingQueue.length === 0) {
        flushAnswers();
        return;
      }
      currentPending = pendingQueue.shift();

      appendLog(``, 'log-divider');
      appendLog(`================================================================================`, 'log-divider2');
      // has_previous ‡∏°‡∏≤‡∏à‡∏≤‡∏Å bot_service (‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ)
      const hasPrev = currentPending.has_previous;
      appendLog(`‚úçÔ∏è  [TEXT INPUT] ‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö${hasPrev ? '‡∏≠‡∏µ‡∏Å' : ''}: ${currentPending.title}`, 'log-ask');

      if (hasPrev) {
        // ‡∏Ç‡πâ‡∏≠ 2+ ‚Üí ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô original)
        _consoleStep = 'ask_linked';
        appendLog(`üëâ ‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏´‡∏°? (y/n) [Enter=‡πÑ‡∏°‡πà]:`, 'log-ask');
        setConsolePrompt(
          `Q${currentPending.q_idx + 1}: ${currentPending.title}`,
          `üëâ ‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏´‡∏°? (y/n) [Enter=‡πÑ‡∏°‡πà]`,
          'y / n'
        );
      } else {
        // ‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å ‚Üí ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÑ‡∏´‡∏°
        _consoleStep = 'want_answer';
        appendLog(`üëâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡πÑ‡∏´‡∏°? (y/n) [Enter=‡∏Ç‡πâ‡∏≤‡∏°]:`, 'log-ask');
        setConsolePrompt(
          `Q${currentPending.q_idx + 1}: ${currentPending.title}`,
          `üëâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡πÑ‡∏´‡∏°? (y/n) [Enter=‡∏Ç‡πâ‡∏≤‡∏°]`,
          'y / n'
        );
      }
    }

    function nextQ() {
      currentPending = null;
      hideConsoleInput();
      if (pendingQueue.length > 0) setTimeout(showNextQuestion, 150);
      else flushAnswers();
    }

    function handleConsoleEnter() {
      const inp = document.getElementById('consoleInput');
      const rawOrig = inp.value.trim();
      const raw = rawOrig.toLowerCase();
      inp.value = '';

      // --- Step: want_answer (‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å) ---
      if (_consoleStep === 'want_answer') {
        appendLog(`‚ùØ ${rawOrig || 'Enter'}`, 'log-input');
        if (raw === 'y') {
          _isLinkedDecision = false;  // ‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ linked
          _consoleStep = 'type_answer';
          appendLog(`‚å®Ô∏è  ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ +, ‡πÄ‡∏ä‡πà‡∏ô 3+5+4):`, 'log-ask');
          setConsolePrompt(
            document.getElementById('consoleQuestion').textContent,
            `‚å®Ô∏è  ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ +, ‡πÄ‡∏ä‡πà‡∏ô 3+5+4)`,
            '‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö1+‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö2+‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö3'
          );
        } else {
          appendLog(`‚è≠Ô∏è  ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ...`, 'log-muted');
          nextQ();
        }

      // --- Step: ask_linked (‡∏Ç‡πâ‡∏≠ 2+) ---
      } else if (_consoleStep === 'ask_linked') {
        appendLog(`‚ùØ ${rawOrig || 'Enter'}`, 'log-input');
        _isLinkedDecision = (raw === 'y');
        _consoleStep = 'type_answer';
        appendLog(`‚å®Ô∏è  ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ +, ‡πÄ‡∏ä‡πà‡∏ô 3+5+4):`, 'log-ask');
        setConsolePrompt(
          document.getElementById('consoleQuestion').textContent,
          `‚å®Ô∏è  ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ +, ‡πÄ‡∏ä‡πà‡∏ô 3+5+4)`,
          '‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö1+‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö2+‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö3'
        );

      // --- Step: type_answer ---
      } else if (_consoleStep === 'type_answer') {
        appendLog(`‚ùØ ${rawOrig || 'Enter'}`, 'log-input');
        const key = `${currentPending.q_idx}_${currentPending.t_idx}`;

        if (!rawOrig) {
          appendLog(`‚è≠Ô∏è  ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ...`, 'log-muted');
          nextQ();
          return;
        }

        const choices = rawOrig.split('+').map(x => x.trim()).filter(x => x);
        _answers[key] = { choices, is_linked: _isLinkedDecision };

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô terminal ‡πÄ‡∏î‡∏¥‡∏°
        if (!_isLinkedDecision) {
          const idx = Math.floor(Math.random() * choices.length);
          appendLog(`‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≠‡∏ö: ${choices[idx]} (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà ${idx + 1})`, 'log-success');
        } else {
          // linked ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏ö‡∏≠‡∏ó‡∏à‡∏∞ sync ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≠‡∏ô run)
          appendLog(`‚úÖ ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô)`, 'log-success');
        }

        nextQ();
      }
    }

    function setConsolePrompt(questionText, hintText, placeholder) {
      const bar = document.getElementById('consoleInputBar');
      document.getElementById('consoleQuestion').textContent = questionText;
      document.getElementById('consoleHint').textContent = hintText;
      document.getElementById('consoleInput').placeholder = placeholder;
      bar.style.display = 'block';
      setTimeout(() => document.getElementById('consoleInput').focus(), 80);
    }

    function flushAnswers() {
      appendLog(`‚ñ∂Ô∏è ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠...`, 'log-info');
      fetch('/api/bot/answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers: _answers })
      })
      .then(r => r.json())
      .then(d => {
        if (!d.ok) appendLog('‚ùå ' + d.error, 'log-error');
        Object.keys(_answers).forEach(k => delete _answers[k]);
      })
      .catch(e => appendLog('‚ùå ' + e, 'log-error'));
    }

    function hideConsoleInput() {
      document.getElementById('consoleInputBar').style.display = 'none';
      document.getElementById('consoleInput').value = '';
      _consoleStep = null;
    }

    // =====================
    // Bot controls
    // =====================
    function startBot() {
      const config = getConfig();
      if (!config.url) { alert('‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Form'); return; }

      logOffset = 0;
      pendingQueue = [];
      currentPending = null;
      Object.keys(_answers).forEach(k => delete _answers[k]);

      const terminal = document.getElementById('logTerminal');
      terminal.innerHTML = '<div class="log-placeholder"><span class="placeholder-icon">‚ñ∂</span><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏≠‡∏ó...</span></div>';
      hideConsoleInput();

      fetch('/api/bot/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      })
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          appendLog('üöÄ ' + data.message);
          if (pollInterval) clearInterval(pollInterval);
          pollInterval = setInterval(pollLogs, 1000);
        } else {
          appendLog('‚ùå ' + data.error);
        }
      })
      .catch(e => appendLog('‚ùå Network error: ' + e));
    }

    function stopBot() {
      fetch('/api/bot/stop', { method: 'POST' })
        .then(r => r.json())
        .then(data => appendLog('üõë ' + data.message));
      hideConsoleInput();
      pendingQueue = [];
      currentPending = null;
    }

    function clearLogs() {
      const terminal = document.getElementById('logTerminal');
      terminal.innerHTML = '<div class="log-placeholder"><span class="placeholder-icon">‚å¨</span><span>‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á... ‡∏Å‡∏î START BOT ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span></div>';
      logOffset = 0;
    }

    // Auto-poll on page load if running
    fetch('/api/bot/status')
      .then(r => r.json())
      .then(data => {
        if (data.running) {
          if (pollInterval) clearInterval(pollInterval);
          pollInterval = setInterval(pollLogs, 1000);
        }
      });
  </script>

</body>
</html>